# 设备名称缓存修复

## 问题

第一次扫描时设备有名字，但后续扫描时变成"未知设备"。

## 原因分析

### BLE设备广播行为

BLE设备的广播数据包含多种信息，但**不是每次都广播完整信息**：

1. **第一次广播**：
   - 设备刚开始广播时，通常会发送完整信息
   - 包括设备名称（`advName`）

2. **后续广播**：
   - 为了节省电量，设备可能只发送必要信息
   - 可能不包含设备名称
   - 只包含UUID、信号强度等

### 代码问题

**修改前的逻辑**：
```dart
final deviceInfo = DeviceInfo.fromScanResult(result);
String finalName = deviceInfo.name;  // 每次都从扫描结果获取
```

- 每次扫描都重新从 `ScanResult` 获取名称
- 如果当前广播包不包含名称，就显示为"未知设备"
- 没有保存之前获取到的名称

**结果**：
```
第1次扫描: result.advName = "LMNB" → 显示 "LMNB" ✅
第2次扫描: result.advName = "" → 显示 "未知设备" ❌
第3次扫描: result.advName = "" → 显示 "未知设备" ❌
```

## 解决方案

### 添加设备名称缓存

**核心思想**：一旦获取到设备名称，就永久保存，后续扫描时优先使用缓存。

### 实现细节

#### 1. 添加名称缓存

```dart
class DeviceRepositoryImpl implements DeviceRepository {
  final Map<String, String> _deviceNameCache = {};  // 新增：名称缓存
  // ...
}
```

#### 2. 名称获取优先级

```dart
String finalName = deviceInfo.name;

// 优先级1: 如果当前扫描到了有效名称，更新缓存
if (finalName != '未知设备') {
  _deviceNameCache[deviceId] = finalName;
}
// 优先级2: 如果当前名称是"未知设备"，尝试从缓存获取
else if (_deviceNameCache.containsKey(deviceId)) {
  finalName = _deviceNameCache[deviceId]!;
}
// 优先级3: 如果缓存中也没有，尝试从已配对设备获取
else if (bondedNames.containsKey(deviceId)) {
  finalName = bondedNames[deviceId]!;
  _deviceNameCache[deviceId] = finalName; // 同时更新缓存
}
```

### 工作流程

```
第1次扫描:
  result.advName = "LMNB"
  → 显示 "LMNB"
  → 缓存["50:f7:ed:36:79:b4"] = "LMNB" ✅

第2次扫描:
  result.advName = ""
  → 当前名称 = "未知设备"
  → 从缓存获取 = "LMNB"
  → 显示 "LMNB" ✅

第3次扫描:
  result.advName = ""
  → 当前名称 = "未知设备"
  → 从缓存获取 = "LMNB"
  → 显示 "LMNB" ✅
```

## 优势

### 1. 名称持久化

- ✅ 一旦获取到名称，永久保存
- ✅ 后续扫描不会丢失名称
- ✅ 即使设备不再广播名称，仍然显示正确名称

### 2. 多来源支持

名称获取优先级：
1. **当前扫描结果**：最新的名称
2. **缓存**：之前扫描到的名称
3. **已配对设备**：系统保存的名称
4. **未知设备**：最后的默认值

### 3. 自动更新

- ✅ 如果设备名称改变，会自动更新缓存
- ✅ 支持设备重命名

## 技术细节

### 缓存键

使用设备ID（MAC地址小写）作为缓存键：
```dart
final deviceId = result.device.remoteId.toString().toLowerCase();
_deviceNameCache[deviceId] = finalName;
```

### 缓存生命周期

- **创建**：应用启动时创建空缓存
- **更新**：每次扫描到有效名称时更新
- **清除**：应用关闭时自动清除

**注意**：缓存是内存中的，应用重启后会清空。但这不是问题，因为：
- 第一次扫描通常会获取到名称
- 已配对设备的名称会从系统获取

### 性能影响

- ✅ 内存占用极小（每个设备约 50 字节）
- ✅ 查找速度快（HashMap O(1)）
- ✅ 不影响扫描性能

## 测试场景

### 场景 1：正常扫描

```
1. 第一次扫描 → 设备显示 "LMNB"
2. 停止扫描
3. 再次扫描 → 设备仍然显示 "LMNB" ✅
```

### 场景 2：设备间歇广播名称

```
1. 扫描开始 → 设备显示 "LMNB"
2. 持续扫描 → 设备持续显示 "LMNB" ✅
   （即使某些广播包不包含名称）
```

### 场景 3：已配对设备

```
1. 扫描已配对设备
2. 即使设备不广播名称
3. 从系统获取名称 → 显示正确名称 ✅
4. 同时更新缓存
```

### 场景 4：设备重命名

```
1. 设备名称 "Device_A"
2. 设备重命名为 "Device_B"
3. 再次扫描 → 显示 "Device_B" ✅
   （缓存自动更新）
```

## 修改的文件

**文件**：`lib/data/repositories/device_repository_impl.dart`

**修改内容**：
1. 添加 `_deviceNameCache` 字段
2. 修改 `scanDevices()` 方法中的名称获取逻辑

## 测试步骤

1. **运行应用**：
   ```bash
   ./run-linux.sh
   ```

2. **第一次扫描**：
   - 进入"设备"标签页
   - 点击"开始扫描"
   - 记录设备名称（如 "LMNB"）

3. **停止扫描**：
   - 点击"停止扫描"

4. **第二次扫描**：
   - 再次点击"开始扫描"
   - 确认设备名称仍然是 "LMNB" ✅

5. **持续扫描**：
   - 长时间扫描（1-2分钟）
   - 确认设备名称不会变成"未知设备" ✅

## 预期结果

✅ 第一次扫描获取到的设备名称会被保存
✅ 后续扫描时设备名称不会丢失
✅ 即使设备不广播名称，仍然显示正确名称
✅ 已配对设备的名称正确显示
✅ 设备重命名后会自动更新

## 相关问题

### Q: 缓存会一直增长吗？

A: 不会。缓存只保存扫描到的设备，通常不超过 10-20 个设备。内存占用可忽略不计。

### Q: 应用重启后缓存会丢失吗？

A: 是的，但这不是问题：
- 第一次扫描通常会获取到名称
- 已配对设备从系统获取名称
- 缓存会快速重建

### Q: 如果设备改名了怎么办？

A: 缓存会自动更新。当扫描到新名称时，会覆盖旧名称。

## 总结

通过添加设备名称缓存，解决了BLE设备间歇性广播名称导致的名称丢失问题。现在设备名称会被持久保存，后续扫描时不会变成"未知设备"，大大改善了用户体验。
