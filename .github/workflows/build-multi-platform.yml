name: Build Multi-Platform

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true

    - name: Install dependencies
      run: flutter pub get

    - name: Fix flutter_blue_plus_android plugin
      run: |
        PLUGIN_PATH="$HOME/.pub-cache/hosted/pub.dev/flutter_blue_plus_android-7.0.4/android/build.gradle"
        if [ -f "$PLUGIN_PATH" ]; then
          sed -i 's/compileSdkVersion = flutter.compileSdkVersion/compileSdk 34/' "$PLUGIN_PATH"
          echo "✓ Fixed flutter_blue_plus_android plugin"
        fi

    - name: Fix flutter_libserialport plugin
      run: |
        PLUGIN_PATH="$HOME/.pub-cache/hosted/pub.dev/flutter_libserialport-0.4.0/android/build.gradle"
        if [ -f "$PLUGIN_PATH" ]; then
          # Add namespace if not exists
          if ! grep -q "namespace" "$PLUGIN_PATH"; then
            sed -i '/^android {/a\    namespace '\''org.sigrok.flutter_libserialport'\''' "$PLUGIN_PATH"
          fi
          # Update compileSdkVersion
          sed -i 's/compileSdkVersion .*/compileSdkVersion 34/' "$PLUGIN_PATH"
          # Update minSdkVersion
          sed -i 's/minSdkVersion 16/minSdkVersion 21/' "$PLUGIN_PATH"
          # Add Java compatibility if not exists
          if ! grep -q "compileOptions" "$PLUGIN_PATH"; then
            sed -i '/defaultConfig {/i\    compileOptions {\n        sourceCompatibility JavaVersion.VERSION_1_8\n        targetCompatibility JavaVersion.VERSION_1_8\n    }\n\n    kotlinOptions {\n        jvmTarget = '\''1.8'\''\n    }\n' "$PLUGIN_PATH"
          fi
          echo "✓ Fixed flutter_libserialport plugin"
        fi

    - name: Build Android APK
      run: flutter build apk --release

    - name: Get version
      id: version
      run: |
        VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Rename APK
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        mv build/app/outputs/flutter-apk/app-release.apk \
           build/app/outputs/flutter-apk/ProgrammingCardHost_v${VERSION}_Android.apk

    - name: Upload Android APK
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: build/app/outputs/flutter-apk/ProgrammingCardHost_*.apk
        retention-days: 30

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-artifact
        path: build/app/outputs/flutter-apk/ProgrammingCardHost_*.apk
        retention-days: 1

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true

    - name: Install dependencies
      run: flutter pub get

    - name: Build Windows Release
      run: flutter build windows --release

    - name: Get version
      id: version
      shell: pwsh
      run: |
        $content = Get-Content pubspec.yaml
        $version = ($content | Select-String -Pattern 'version:\s*(.+)').Matches.Groups[1].Value
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"

    - name: Create Release Archive
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $archiveName = "ProgrammingCardHost_v${version}_Windows_x64.zip"
        Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath $archiveName
        echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_OUTPUT
      id: archive

    - name: Upload Windows Build
      uses: actions/upload-artifact@v4
      with:
        name: windows-release
        path: build/windows/x64/runner/Release/
        retention-days: 30

    - name: Upload Windows ZIP
      uses: actions/upload-artifact@v4
      with:
        name: windows-release-zip
        path: ${{ steps.archive.outputs.ARCHIVE_NAME }}
        retention-days: 30

    - name: Upload Windows ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-zip-artifact
        path: ${{ steps.archive.outputs.ARCHIVE_NAME }}
        retention-days: 1

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.5'
        channel: 'stable'
        cache: true

    - name: Install dependencies
      run: flutter pub get

    - name: Build Linux Release
      run: flutter build linux --release

    - name: Get version
      id: version
      run: |
        VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Create Release Archive
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        cd build/linux/x64/release/bundle
        tar -czf ../../../../../ProgrammingCardHost_v${VERSION}_Linux_x64.tar.gz *
        cd ../../../../../

    - name: Upload Linux Build
      uses: actions/upload-artifact@v4
      with:
        name: linux-release
        path: build/linux/x64/release/bundle/
        retention-days: 30

    - name: Upload Linux Archive
      uses: actions/upload-artifact@v4
      with:
        name: linux-release-tar
        path: ProgrammingCardHost_*.tar.gz
        retention-days: 30

    - name: Upload Linux tar artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-tar-artifact
        path: ProgrammingCardHost_*.tar.gz
        retention-days: 1

  create-release:
    needs: [build-android, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: version
      run: |
        VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure
      run: ls -R artifacts

    - name: Create or update release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        TAG="v${VERSION}"

        # 检查 release 是否存在
        if gh release view "$TAG" >/dev/null 2>&1; then
          echo "Release $TAG already exists, deleting old assets..."
          gh release delete "$TAG" --yes || true
          git push origin ":refs/tags/$TAG" || true
        fi

        # 创建新的 tag
        git tag "$TAG" || true
        git push origin "$TAG" || true

        # 创建 release notes
        cat > release_notes.md << 'EOF'
        ## 自动构建版本 v${VERSION}

        构建时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        提交: ${{ github.sha }}

        ### 下载说明

        * Windows: 解压 ZIP 文件后运行 programming_card_host.exe
        * Android: 直接安装 APK 文件
        * Linux: 解压 tar.gz 文件后运行 programming_card_host

        ### 更新内容

        查看提交历史了解详细更新内容。
        EOF

        # 创建 release
        gh release create "$TAG" \
          --title "Programming Card Host v${VERSION}" \
          --notes-file release_notes.md \
          artifacts/apk-artifact/*.apk \
          artifacts/windows-zip-artifact/*.zip \
          artifacts/linux-tar-artifact/*.tar.gz
