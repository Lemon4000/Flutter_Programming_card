# 恢复显示未知设备

## 问题

过滤掉未知设备后出现了两个问题：
1. **扫描变慢**：设备发现速度明显降低
2. **设备扫描不到**：某些设备无法被发现

## 原因分析

过滤未知设备可能导致：
- 扫描结果流被过度过滤，导致UI更新频率降低
- 某些设备在初次扫描时名称为空，但后续会广播名称
- 过滤逻辑可能影响了扫描流的正常处理

## 解决方案

**恢复显示所有设备（包括未知设备）**

### 修改内容

**文件**：`lib/data/repositories/device_repository_impl.dart`

**修改前**：
```dart
final devices = scanResults
    .map((result) {
      // ... 转换逻辑
    })
    .where((device) => device.name != '未知设备') // 过滤掉未知设备
    .toList();
```

**修改后**：
```dart
final devices = scanResults
    .map((result) {
      // ... 转换逻辑
    })
    // 注释掉过滤，恢复显示所有设备（包括未知设备）
    // .where((device) => device.name != '未知设备')
    .toList();
```

## 效果

### 修改前（过滤未知设备）
- ❌ 扫描变慢
- ❌ 某些设备扫描不到
- ✅ 界面清爽（只显示有名称的设备）

### 修改后（显示所有设备）
- ✅ 扫描速度正常
- ✅ 所有设备都能被发现
- ⚠️ 会显示一些"未知设备"

## 为什么需要显示未知设备

1. **完整性**：
   - 某些BLE设备不广播名称
   - 但仍然可以连接和使用
   - 用户可能需要通过MAC地址识别

2. **调试需求**：
   - 开发和调试时需要看到所有设备
   - 即使没有名称也需要尝试连接

3. **性能**：
   - 不过滤可以保持扫描流的正常处理
   - 避免影响扫描性能

## 用户体验优化建议

虽然恢复了显示未知设备，但可以通过以下方式优化用户体验：

### 1. 视觉区分

在UI中区分已知设备和未知设备：

```dart
// 未知设备使用灰色或特殊图标
if (device.name == '未知设备') {
  // 显示为灰色
  color: Colors.grey;
  icon: Icons.bluetooth_disabled;
} else {
  // 正常显示
  color: Colors.blue;
  icon: Icons.bluetooth;
}
```

### 2. 排序优化

将有名称的设备排在前面：

```dart
devices.sort((a, b) {
  // 先按是否有名称排序
  if (a.name == '未知设备' && b.name != '未知设备') return 1;
  if (a.name != '未知设备' && b.name == '未知设备') return -1;

  // 再按信号强度排序
  return b.rssi.compareTo(a.rssi);
});
```

### 3. 添加过滤选项

在UI中添加一个开关，让用户选择是否显示未知设备：

```dart
// 在扫描页面添加开关
SwitchListTile(
  title: Text('显示未知设备'),
  value: showUnknownDevices,
  onChanged: (value) {
    setState(() => showUnknownDevices = value);
  },
);
```

## 当前状态

- ✅ 恢复显示所有设备
- ✅ 扫描速度恢复正常
- ✅ 所有设备都能被发现
- ⚠️ 会显示"未知设备"（但这是必要的）

## 测试步骤

1. 运行应用：
   ```bash
   ./run-linux.sh
   ```

2. 进入"设备"标签页

3. 点击"开始扫描"

4. 观察：
   - 扫描速度是否恢复正常
   - 是否能发现所有设备
   - 未知设备是否正常显示

## 预期结果

✅ 扫描速度正常
✅ 所有设备都能被发现
✅ 已配对设备显示正确名称
✅ 未配对且无名称的设备显示为"未知设备"

## 总结

虽然显示未知设备会让界面不那么清爽，但这是保证扫描性能和完整性的必要代价。未来可以通过UI优化（如视觉区分、排序、过滤选项）来改善用户体验，而不是直接过滤掉这些设备。
