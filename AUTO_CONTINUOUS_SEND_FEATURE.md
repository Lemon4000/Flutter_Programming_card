# 自动连续发送全部数据帧功能

## 功能说明

### 问题
之前的"连续发送模式"需要用户手动连续点击按钮，发送间隔设置没有实际作用。

### 解决方案
添加"连续发送全部"按钮，点击一次后自动按照设定的间隔连续发送所有数据帧。

## 新增功能

### 1. 连续发送全部按钮

**位置**：数据帧卡片的输入区域底部

**功能**：
- 点击一次，自动发送从当前块到最后一块的所有数据
- 按照设定的发送间隔自动发送
- 实时更新块索引和日志

**按钮文本**：`连续发送全部 (N 块)`
- N 是数据块总数

### 2. 停止按钮

**显示条件**：正在连续发送时显示

**功能**：
- 立即停止连续发送
- 保留当前块索引位置
- 可以从停止的位置继续发送

### 3. 发送间隔的实际应用

现在发送间隔真正起作用了：
- 设置 50ms：快速发送，适合测试
- 设置 100ms：正常速度（默认）
- 设置 500ms：慢速发送，便于观察

## 使用方法

### 基本使用

1. **加载 HEX 文件**
   - 点击"选择 HEX"按钮
   - 选择固件文件

2. **设置发送间隔**
   - 在"发送设置"区域调整滑块
   - 推荐值：100-200ms

3. **开始连续发送**
   - 点击"连续发送全部"按钮
   - 自动发送所有数据块

4. **停止发送（可选）**
   - 点击"停止"按钮
   - 立即停止发送

### 高级使用

**从中间位置开始发送**：
1. 使用滑块选择起始块
2. 点击"连续发送全部"
3. 从选定的块开始发送到最后

**分段发送**：
1. 发送一部分后点击"停止"
2. 调整设置或检查设备状态
3. 再次点击"连续发送全部"继续

## 工作流程

```
用户点击"连续发送全部"
    ↓
开始循环发送
    ↓
发送块 N → 等待间隔 → 发送块 N+1 → 等待间隔 → ...
    ↓
直到最后一块或用户点击"停止"
    ↓
发送完成
```

## 技术实现

### 核心方法

```dart
Future<void> _sendAllDataFrames() async {
  // 标记为正在连续发送
  ref.read(isContinuousSendingProvider.notifier).state = true;

  try {
    // 从当前块开始发送到最后一块
    for (int i = startIndex; i < dataBlocks.length; i++) {
      // 检查是否被停止
      if (!ref.read(isContinuousSendingProvider)) {
        break;
      }

      // 发送当前块
      await debugService.sendDataFrame(...);

      // 等待发送间隔
      await Future.delayed(Duration(milliseconds: sendInterval));
    }
  } finally {
    // 清除发送状态
    ref.read(isContinuousSendingProvider.notifier).state = false;
  }
}
```

### 停止机制

```dart
void _stopContinuousSending() {
  // 设置标志为 false
  ref.read(isContinuousSendingProvider.notifier).state = false;

  // 循环中会检查这个标志并退出
}
```

## UI 设计

### 数据帧卡片布局

```
┌─────────────────────────────────────┐
│ 📊 数据帧                            │
├─────────────────────────────────────┤
│ 文件: firmware.hex  [选择 HEX]      │
│                                     │
│ 数据块: [━━━━●━━━━] 5 / 99          │
│                                     │
│ ┌─────────────────────────────┐    │
│ │ 地址: 0x00001000            │    │
│ │ 大小: 256 字节              │    │
│ └─────────────────────────────┘    │
│                                     │
│ [▶ 连续发送全部 (100 块)]  [⏹ 停止] │
│                                     │
│ [发送]                              │
└─────────────────────────────────────┘
```

### 按钮状态

**未发送时**：
- ✅ "连续发送全部"按钮：绿色，可点击
- ❌ "停止"按钮：隐藏

**发送中**：
- ❌ "连续发送全部"按钮：灰色，禁用
- ✅ "停止"按钮：红色，可点击

## 日志输出示例

```
[14:30:00.123] 发送数据帧: 块 0/99, 地址 0x00001000
[14:30:00.234] 数据帧响应: 成功
[14:30:00.334] 发送数据帧: 块 1/99, 地址 0x00001100
[14:30:00.445] 数据帧响应: 成功
[14:30:00.545] 发送数据帧: 块 2/99, 地址 0x00001200
...
[14:30:10.123] 连续发送完成
```

## 优势

### 1. 真正的自动化
- ✅ 点击一次，自动完成所有发送
- ✅ 无需手动连续点击
- ✅ 发送间隔真正起作用

### 2. 灵活控制
- ✅ 可以随时停止
- ✅ 可以从任意位置开始
- ✅ 可以调整发送速度

### 3. 实时反馈
- ✅ 实时显示当前块索引
- ✅ 详细的日志记录
- ✅ 响应状态显示

## 使用场景

### 场景 1：完整烧录固件

```
1. 加载 HEX 文件
2. 设置发送间隔 100ms
3. 点击"连续发送全部"
4. 等待自动完成（约 10 秒，100 块）
```

### 场景 2：测试设备稳定性

```
1. 设置发送间隔 50ms（快速）
2. 点击"连续发送全部"
3. 观察设备是否能处理高速数据
```

### 场景 3：分段烧录

```
1. 发送前 50 块
2. 点击"停止"
3. 检查设备状态
4. 继续发送剩余块
```

## 注意事项

### 1. 发送间隔的选择

⚠️ **太快（< 50ms）**：
- 设备可能来不及处理
- 可能导致数据丢失

✅ **推荐（100-200ms）**：
- 平衡速度和稳定性
- 适合大多数设备

⚠️ **太慢（> 500ms）**：
- 发送时间过长
- 效率低

### 2. 停止后的状态

- 停止后块索引保持在当前位置
- 可以继续发送剩余块
- 或者重新选择起始块

### 3. 错误处理

- 单个块发送失败不会中断整个流程
- 会记录错误日志
- 继续发送下一块

## 修改的文件

1. `lib/presentation/providers/debug_providers.dart`
   - 新增 `isContinuousSendingProvider`

2. `lib/presentation/screens/debug_screen.dart`
   - 新增 `_sendAllDataFrames()` 方法
   - 新增 `_stopContinuousSending()` 方法
   - 修改 `_buildDataFrameInput()` 方法，添加按钮

## 测试步骤

1. **运行应用**：
   ```bash
   ./run-linux.sh
   ```

2. **连接设备**

3. **进入调试页面**

4. **加载 HEX 文件**

5. **设置发送间隔**（如 100ms）

6. **点击"连续发送全部"**

7. **观察**：
   - 块索引自动递增
   - 日志实时更新
   - 按照设定间隔发送

8. **测试停止功能**：
   - 发送过程中点击"停止"
   - 确认立即停止

## 预期结果

✅ 点击一次自动发送所有数据块
✅ 发送间隔正确应用
✅ 块索引自动更新
✅ 可以随时停止
✅ 日志详细记录每次发送

## 总结

通过添加"连续发送全部"功能，真正实现了自动化批量发送，发送间隔设置也有了实际意义。用户只需点击一次，就可以自动完成所有数据块的发送，大大提高了调试效率。
