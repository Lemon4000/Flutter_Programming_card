# 串口波特率配置功能

## ✅ 新增功能

现在您可以在UI中自由选择串口波特率了！

## 🎯 功能特性

### 1. 波特率选择器

在串口模式下，会显示一个波特率下拉菜单，提供以下选项：

| 波特率 | 说明 | 适用场景 |
|--------|------|----------|
| 9600 | 最慢 | 老旧设备、长距离传输 |
| 19200 | 很慢 | 低速设备 |
| 38400 | 慢 | 标准低速通信 |
| 57600 | 中低速 | 常用低速率 |
| **115200** | **标准（推荐）** | **最佳兼容性** ⭐ |
| 230400 | 中速 | 较快传输 |
| 460800 | 快 | 高速传输 |
| 921600 | 很快 | 高速设备 |
| 2000000 | 极快 | 高端设备（可能不稳定） |

### 2. 实时显示

- 连接对话框显示当前波特率
- 串口列表显示选择的波特率
- 配置保存在会话中

### 3. 默认值

- 默认波特率：**115200 bps**
- 推荐用于大多数USB转串口设备

## 🚀 使用方法

### 步骤1：切换到串口模式

1. 打开应用
2. 进入"设备"标签
3. 点击顶部的"串口"按钮

### 步骤2：选择波特率

在通信方式选择器下方，会出现波特率选择器：

```
┌─────────────────────────────────┐
│ 🔧 波特率: [115200 bps (推荐) ▼]│
└─────────────────────────────────┘
```

点击下拉菜单，选择合适的波特率。

### 步骤3：连接串口

1. 点击"刷新串口列表"
2. 选择目标串口
3. 点击"连接"按钮
4. 连接对话框会显示：`正在连接串口 (115200 bps)...`

### 步骤4：使用功能

连接成功后，所有数据传输都会使用您选择的波特率。

## 💡 波特率选择建议

### 首次使用

**推荐：115200 bps**
- 兼容性最好
- 稳定性高
- 适合大多数设备

### 如果连接失败

尝试降低波特率：
1. 115200 → 57600
2. 57600 → 38400
3. 38400 → 19200

### 如果需要更快速度

确认设备支持后，尝试提高：
1. 115200 → 230400
2. 230400 → 460800
3. 460800 → 921600

### 高速传输（2000000）

⚠️ **注意**：
- 需要高质量USB线缆
- 需要设备明确支持
- 可能不稳定
- 建议先用低速率测试

## 🔧 技术细节

### 实现位置

**Provider**: `lib/presentation/providers/providers.dart`
```dart
final serialPortBaudRateProvider = StateProvider<int>((ref) => 115200);
```

**UI**: `lib/presentation/screens/scan_screen.dart`
- 波特率下拉菜单
- 动态显示当前波特率
- 连接时使用选择的波特率

### 配置范围

支持的波特率：
- 最小：9600 bps
- 最大：2000000 bps
- 标准值：9600, 19200, 38400, 57600, 115200, 230400, 460800, 921600, 2000000

### 状态管理

- 波特率选择保存在Riverpod状态中
- 切换串口时保持选择
- 应用重启后恢复默认值（115200）

## 📊 性能对比

### 传输1MB数据的理论时间

| 波特率 | 理论时间 | 实际时间（约） |
|--------|----------|----------------|
| 9600 | 104秒 | ~120秒 |
| 115200 | 8.7秒 | ~10秒 |
| 460800 | 2.2秒 | ~3秒 |
| 921600 | 1.1秒 | ~1.5秒 |
| 2000000 | 0.5秒 | ~0.7秒 |

*实际时间包含协议开销和处理延迟*

## 🧪 测试建议

### 测试不同波特率

1. **从低到高测试**：
   ```
   115200 → 连接成功 → 发送数据 → 正常
   230400 → 连接成功 → 发送数据 → 正常
   460800 → 连接成功 → 发送数据 → 正常
   921600 → 连接失败 → 降回460800
   ```

2. **记录最高稳定速率**：
   - 找到设备支持的最高稳定波特率
   - 日常使用该速率

3. **验证数据完整性**：
   - 使用不同波特率烧录同一固件
   - 验证CRC校验
   - 确保数据无误

## 🔍 故障排除

### 问题1：选择高波特率后连接失败

**解决**：
1. 降低波特率
2. 检查设备规格
3. 更换USB线缆

### 问题2：数据传输出错

**解决**：
1. 降低波特率
2. 检查USB接口质量
3. 避免使用USB HUB

### 问题3：波特率选择不生效

**解决**：
1. 确认已选择串口模式
2. 重新连接串口
3. 查看连接对话框确认波特率

## 📝 示例场景

### 场景1：标准使用

```
1. 选择波特率：115200 bps
2. 连接串口：/dev/ttyUSB0
3. 烧录固件：正常完成
4. 速度：约10秒/1MB
```

### 场景2：高速传输

```
1. 选择波特率：921600 bps
2. 连接串口：/dev/ttyUSB0
3. 烧录固件：正常完成
4. 速度：约1.5秒/1MB
```

### 场景3：兼容性优先

```
1. 选择波特率：57600 bps
2. 连接串口：/dev/ttyUSB0
3. 烧录固件：正常完成
4. 速度：约20秒/1MB
```

## ✅ 优势

- 🎛️ **灵活配置**：9种波特率可选
- 🔄 **实时切换**：无需修改代码
- 📊 **可视化**：清晰显示当前配置
- 🛡️ **稳定优先**：默认使用最稳定的115200
- ⚡ **性能可选**：支持高达2000000的高速传输

## 🎉 总结

现在您可以：
- ✅ 在UI中自由选择波特率
- ✅ 根据设备特性优化速度
- ✅ 平衡稳定性和传输速度
- ✅ 无需修改代码即可调整

**推荐配置**：
- 首次使用：115200 bps
- 稳定优先：115200 bps
- 速度优先：921600 bps（需设备支持）
- 兼容优先：57600 bps

---

**更新时间**: 2026-01-21
**默认波特率**: 115200 bps
**可选范围**: 9600 - 2000000 bps
