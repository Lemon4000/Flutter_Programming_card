# 设备名称缓存调试指南

## 🔍 问题描述

用户报告：开始扫描 → 停止扫描 → 再次扫描后，所有设备变成"未知设备"。

## 🛠️ 已添加的调试功能

### 1. 扫描开始日志

```
开始扫描，当前缓存中有 X 个设备名称
缓存内容: {aa:bb:cc:dd:ee:ff: CYW Surpass, ...}
```

### 2. 缓存更新日志

```
更新缓存: aa:bb:cc:dd:ee:ff -> CYW Surpass
```

### 3. 缓存恢复日志

```
从缓存恢复名称: aa:bb:cc:dd:ee:ff -> CYW Surpass
```

### 4. 已配对设备日志

```
从已配对设备获取名称: aa:bb:cc:dd:ee:ff -> CYW Surpass
```

### 5. 未知设备日志

```
设备 aa:bb:cc:dd:ee:ff 无可用名称，显示为未知设备
```

### 6. 缓存保存日志

```
已保存设备名称缓存: X 个设备
```

### 7. 缓存加载日志

```
已加载设备名称缓存: X 个设备
```

## 🧪 调试步骤

### 步骤1：重新编译

```bash
flutter clean
flutter pub get
./run-linux.sh
```

### 步骤2：观察启动日志

应该看到：
```
已加载设备名称缓存: X 个设备
```

如果看到 `0 个设备`，说明缓存为空（首次运行正常）。

### 步骤3：第一次扫描

点击"开始扫描"，观察日志：

```
开始扫描，当前缓存中有 0 个设备名称
```

扫描到设备后：
```
更新缓存: aa:bb:cc:dd:ee:ff -> CYW Surpass
已保存设备名称缓存: 1 个设备
```

### 步骤4：停止扫描

点击"停止扫描"，观察是否有异常日志。

### 步骤5：第二次扫描

再次点击"开始扫描"，观察日志：

```
开始扫描，当前缓存中有 1 个设备名称
缓存内容: {aa:bb:cc:dd:ee:ff: CYW Surpass}
```

如果设备不广播名称：
```
从缓存恢复名称: aa:bb:cc:dd:ee:ff -> CYW Surpass
```

### 步骤6：分析问题

根据日志判断问题：

#### 情况1：缓存为空
```
开始扫描，当前缓存中有 0 个设备名称
```

**原因**：缓存被清空或未保存
**检查**：
- 是否看到"已保存设备名称缓存"日志？
- 是否有保存失败的错误？

#### 情况2：缓存存在但未恢复
```
开始扫描，当前缓存中有 1 个设备名称
设备 aa:bb:cc:dd:ee:ff 无可用名称，显示为未知设备
```

**原因**：设备ID不匹配或缓存查找失败
**检查**：
- 缓存中的设备ID是否与扫描到的设备ID一致？
- 是否有大小写问题？

#### 情况3：设备ID变化
```
开始扫描，当前缓存中有 1 个设备名称
缓存内容: {aa:bb:cc:dd:ee:ff: CYW Surpass}
设备 11:22:33:44:55:66 无可用名称，显示为未知设备
```

**原因**：设备MAC地址变化（不太可能）
**检查**：
- 是否是不同的设备？
- 设备是否重置了MAC地址？

## 🔧 可能的问题和解决方案

### 问题1：缓存未保存

**症状**：
```
更新缓存: aa:bb:cc:dd:ee:ff -> CYW Surpass
（没有"已保存设备名称缓存"日志）
```

**原因**：`cacheUpdated` 标志未正确设置

**解决**：检查代码逻辑

### 问题2：缓存加载失败

**症状**：
```
加载设备名称缓存失败: ...
```

**原因**：SharedPreferences 访问失败

**解决**：
```bash
# 清除应用数据
rm -rf ~/.local/share/programming_card_host/
```

### 问题3：设备ID大小写不一致

**症状**：
```
缓存内容: {AA:BB:CC:DD:EE:FF: CYW Surpass}
设备 aa:bb:cc:dd:ee:ff 无可用名称
```

**原因**：设备ID大小写不统一

**解决**：代码中已统一使用 `toLowerCase()`，应该不会出现此问题

### 问题4：扫描结果为空

**症状**：
```
开始扫描，当前缓存中有 1 个设备名称
（没有任何设备相关日志）
```

**原因**：扫描未找到设备

**解决**：
- 确保设备在范围内
- 确保设备已开启蓝牙
- 等待更长时间

## 📊 正常的日志流程

### 首次运行

```
已加载设备名称缓存: 0 个设备
开始扫描，当前缓存中有 0 个设备名称
更新缓存: aa:bb:cc:dd:ee:ff -> CYW Surpass
已保存设备名称缓存: 1 个设备
```

### 第二次扫描（设备广播名称）

```
开始扫描，当前缓存中有 1 个设备名称
缓存内容: {aa:bb:cc:dd:ee:ff: CYW Surpass}
（设备名称正常显示，无需从缓存恢复）
```

### 第二次扫描（设备不广播名称）

```
开始扫描，当前缓存中有 1 个设备名称
缓存内容: {aa:bb:cc:dd:ee:ff: CYW Surpass}
从缓存恢复名称: aa:bb:cc:dd:ee:ff -> CYW Surpass
```

### 应用重启后

```
已加载设备名称缓存: 1 个设备
开始扫描，当前缓存中有 1 个设备名称
缓存内容: {aa:bb:cc:dd:ee:ff: CYW Surpass}
从缓存恢复名称: aa:bb:cc:dd:ee:ff -> CYW Surpass
```

## 🎯 测试清单

- [ ] 首次扫描能看到设备名称
- [ ] 停止扫描后缓存仍然存在
- [ ] 第二次扫描能恢复设备名称
- [ ] 应用重启后缓存仍然存在
- [ ] 多次扫描设备名称保持稳定

## 📝 收集日志

如果问题仍然存在，请收集以下信息：

1. **完整的控制台日志**
   ```bash
   ./run-linux.sh 2>&1 | tee debug.log
   ```

2. **缓存文件内容**
   ```bash
   cat ~/.local/share/programming_card_host/shared_preferences.json
   ```

3. **操作步骤**
   - 第几次扫描出现问题？
   - 是否重启了应用？
   - 设备是否在范围内？

## 🔍 高级调试

### 启用详细日志

取消注释这行代码（第103行）：
```dart
// print('设备 $deviceId: 扫描名称=$finalName, 缓存=${_deviceNameCache[deviceId]}');
```

改为：
```dart
print('设备 $deviceId: 扫描名称=$finalName, 缓存=${_deviceNameCache[deviceId]}');
```

这会为每个设备打印详细信息。

### 手动检查缓存

在代码中添加：
```dart
print('当前完整缓存: $_deviceNameCache');
```

### 清除缓存测试

```bash
# 清除缓存
rm -rf ~/.local/share/programming_card_host/

# 重新运行
./run-linux.sh
```

## ✅ 预期结果

修复后应该看到：

```
已加载设备名称缓存: 1 个设备
开始扫描，当前缓存中有 1 个设备名称
缓存内容: {aa:bb:cc:dd:ee:ff: CYW Surpass}
从缓存恢复名称: aa:bb:cc:dd:ee:ff -> CYW Surpass
```

设备名称应该始终保持，不会变成"未知设备"。

---

**创建时间**: 2026-01-21
**目的**: 调试设备名称缓存问题
**状态**: 等待用户反馈日志
