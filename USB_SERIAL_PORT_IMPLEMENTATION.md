# USBä¸²å£æ”¯æŒå®ç°å®Œæˆ

## âœ… å·²å®Œæˆ

æˆåŠŸä¸ºFlutteråº”ç”¨æ·»åŠ äº†USBè½¬ä¸²å£è®¾å¤‡çš„æ”¯æŒï¼

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### 1. ç»Ÿä¸€é€šä¿¡æ¥å£

**ä½ç½®**: `lib/data/datasources/communication_datasource.dart`

åˆ›å»ºäº†ç»Ÿä¸€çš„é€šä¿¡æ¥å£ï¼Œæ”¯æŒè“ç‰™å’Œä¸²å£ä¸¤ç§é€šä¿¡æ–¹å¼ï¼š

```dart
abstract class CommunicationDatasource {
  Stream<List<int>> get dataStream;
  Stream<bool> get connectionStateStream;
  bool get isConnected;
  Future<void> write(List<int> data);
  Future<void> disconnect();
  void dispose();
}

enum CommunicationType {
  bluetooth('è“ç‰™'),
  serialPort('ä¸²å£');
}
```

### 2. ä¸²å£æ•°æ®æºå®ç°

**ä½ç½®**: `lib/data/datasources/serial_port_datasource.dart`

å®ç°äº†å®Œæ•´çš„ä¸²å£é€šä¿¡åŠŸèƒ½ï¼š

- âœ… è·å–å¯ç”¨ä¸²å£åˆ—è¡¨
- âœ… è¿æ¥ä¸²å£ï¼ˆå¯é…ç½®æ³¢ç‰¹ç‡ï¼Œé»˜è®¤2000000ï¼‰
- âœ… æ•°æ®æ¥æ”¶æµ
- âœ… æ•°æ®å‘é€
- âœ… è¿æ¥çŠ¶æ€ç®¡ç†
- âœ… èµ„æºæ¸…ç†

**å…³é”®æ–¹æ³•**ï¼š

```dart
// è·å–å¯ç”¨ä¸²å£
List<String> getAvailablePorts()

// è¿æ¥ä¸²å£
Future<void> connect(String portName, {int baudRate = 2000000})

// å‘é€æ•°æ®
Future<void> write(List<int> data)

// æ–­å¼€è¿æ¥
Future<void> disconnect()
```

### 3. UIé›†æˆ

**ä½ç½®**: `lib/presentation/screens/scan_screen.dart`

åœ¨æ‰«æç•Œé¢æ·»åŠ äº†é€šä¿¡æ–¹å¼é€‰æ‹©ï¼š

#### é€šä¿¡ç±»å‹åˆ‡æ¢
- è“ç‰™/ä¸²å£åˆ†æ®µæŒ‰é’®
- è‡ªåŠ¨åˆ‡æ¢æ˜¾ç¤ºå†…å®¹

#### è“ç‰™æ¨¡å¼
- æ‰«æè“ç‰™è®¾å¤‡
- æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
- è¿æ¥è“ç‰™è®¾å¤‡

#### ä¸²å£æ¨¡å¼
- åˆ·æ–°ä¸²å£åˆ—è¡¨
- æ˜¾ç¤ºå¯ç”¨ä¸²å£
- è¿æ¥ä¸²å£è®¾å¤‡
- æ˜¾ç¤ºæ³¢ç‰¹ç‡ä¿¡æ¯

### 4. æ¶æ„é›†æˆ

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š

#### `lib/presentation/providers/providers.dart`
æ·»åŠ äº†æ–°çš„providersï¼š

```dart
// ä¸²å£æ•°æ®æº
final serialPortDatasourceProvider = Provider<SerialPortDatasource>

// é€šä¿¡ç±»å‹é€‰æ‹©
final communicationTypeProvider = StateProvider<CommunicationType>

// é€‰ä¸­çš„ä¸²å£
final selectedSerialPortProvider = StateProvider<String?>

// é€šä¿¡ä»“åº“ï¼ˆæ”¯æŒä¸¤ç§ç±»å‹ï¼‰
final communicationRepositoryProvider = FutureProvider<CommunicationRepository>
```

#### `lib/data/repositories/communication_repository_impl.dart`
ä¿®æ”¹ä¸ºæ”¯æŒä¸¤ç§æ•°æ®æºï¼š

```dart
// è“ç‰™æ„é€ å‡½æ•°
CommunicationRepositoryImpl.bluetooth(
  BluetoothDatasource bluetoothDatasource,
  ProtocolConfig protocolConfig,
  Ref ref,
)

// ä¸²å£æ„é€ å‡½æ•°
CommunicationRepositoryImpl.serialPort(
  SerialPortDatasource serialPortDatasource,
  ProtocolConfig protocolConfig,
  Ref ref,
)

// ç»Ÿä¸€å†™å…¥æ–¹æ³•
Future<void> _writeData(List<int> data)
```

#### `lib/data/services/flash_worker.dart`
è§£è€¦æ•°æ®æºä¾èµ–ï¼š

```dart
// ä¹‹å‰ï¼šç›´æ¥ä¾èµ– BluetoothDatasource
final BluetoothDatasource bluetoothDatasource;

// ç°åœ¨ï¼šä½¿ç”¨å†™å…¥å‡½æ•°
final Future<void> Function(List<int>) writeData;
```

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### 1. é€šä¿¡æ–¹å¼é€‰æ‹©

- **ä½ç½®**: æ‰«æç•Œé¢é¡¶éƒ¨
- **æ ·å¼**: åˆ†æ®µæŒ‰é’®ï¼ˆSegmented Buttonï¼‰
- **é€‰é¡¹**: è“ç‰™ / ä¸²å£
- **å›¾æ ‡**: è“ç‰™å›¾æ ‡ / USBå›¾æ ‡

### 2. ä¸²å£åˆ—è¡¨

- **åˆ·æ–°æŒ‰é’®**: æ‰‹åŠ¨åˆ·æ–°å¯ç”¨ä¸²å£
- **è‡ªåŠ¨åŠ è½½**: åˆ‡æ¢åˆ°ä¸²å£æ¨¡å¼æ—¶è‡ªåŠ¨åŠ è½½
- **æ˜¾ç¤ºä¿¡æ¯**:
  - ä¸²å£åç§°ï¼ˆå¦‚ `/dev/ttyUSB0` æˆ– `COM3`ï¼‰
  - æ³¢ç‰¹ç‡ï¼ˆ2000000 bpsï¼‰
  - è¿æ¥çŠ¶æ€

### 3. è¿æ¥ç®¡ç†

- **è¿æ¥å¯¹è¯æ¡†**: æ˜¾ç¤ºè¿æ¥è¿›åº¦
- **çŠ¶æ€åŒæ­¥**: å…¨å±€è¿æ¥çŠ¶æ€æ›´æ–°
- **é”™è¯¯å¤„ç†**: è¿æ¥å¤±è´¥æç¤º
- **æˆåŠŸæç¤º**: è¿æ¥æˆåŠŸé€šçŸ¥

## ğŸ¯ ä½¿ç”¨æµç¨‹

### è¿æ¥USBä¸²å£è®¾å¤‡

1. **è¿æ¥ç¡¬ä»¶**
   - å°†USBè½¬ä¸²å£è®¾å¤‡æ’å…¥ç”µè„‘
   - ç¡®ä¿é©±åŠ¨å·²å®‰è£…

2. **æ‰“å¼€åº”ç”¨**
   ```bash
   ./run-linux.sh
   ```

3. **åˆ‡æ¢åˆ°ä¸²å£æ¨¡å¼**
   - è¿›å…¥"è®¾å¤‡"æ ‡ç­¾
   - ç‚¹å‡»"ä¸²å£"æŒ‰é’®

4. **åˆ·æ–°ä¸²å£åˆ—è¡¨**
   - ç‚¹å‡»"åˆ·æ–°ä¸²å£åˆ—è¡¨"æŒ‰é’®
   - æŸ¥çœ‹å¯ç”¨ä¸²å£

5. **è¿æ¥ä¸²å£**
   - é€‰æ‹©ç›®æ ‡ä¸²å£
   - ç‚¹å‡»"è¿æ¥"æŒ‰é’®
   - ç­‰å¾…è¿æ¥æˆåŠŸ

6. **ä½¿ç”¨åŠŸèƒ½**
   - è¿›å…¥"çƒ§å½•"æˆ–"è°ƒè¯•"æ ‡ç­¾
   - æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½
   - æ•°æ®é€šè¿‡ä¸²å£ä¼ è¾“

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### 1. ä¾èµ–åŒ…

```yaml
dependencies:
  flutter_libserialport: ^0.4.0
```

### 2. æ³¢ç‰¹ç‡é…ç½®

é»˜è®¤æ³¢ç‰¹ç‡ï¼š**2000000 bps**

å¯åœ¨è¿æ¥æ—¶ä¿®æ”¹ï¼š
```dart
await serialPortDatasource.connect(portName, baudRate: 115200);
```

### 3. æ•°æ®æµå¤„ç†

ä¸²å£å’Œè“ç‰™ä½¿ç”¨ç›¸åŒçš„æ•°æ®æµæ¥å£ï¼š

```dart
Stream<List<int>> get dataStream;
```

æ‰€æœ‰åè®®è§£æã€å¸§å¤„ç†é€»è¾‘å®Œå…¨å¤ç”¨ã€‚

### 4. é”™è¯¯å¤„ç†

- ä¸²å£ä¸å­˜åœ¨ï¼šæç¤ºæœªæ‰¾åˆ°è®¾å¤‡
- æ‰“å¼€å¤±è´¥ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- å†™å…¥å¤±è´¥ï¼šæŠ›å‡ºå¼‚å¸¸å¹¶è®°å½•æ—¥å¿—
- è¿æ¥æ–­å¼€ï¼šè‡ªåŠ¨æ¸…ç†èµ„æº

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å‡†å¤‡ç¯å¢ƒ

```bash
# ç¡®ä¿ä¾èµ–å·²å®‰è£…
flutter pub get

# æ£€æŸ¥ç¼–è¯‘
flutter analyze
```

### 2. è¿æ¥æµ‹è¯•

1. æ’å…¥USBè½¬ä¸²å£è®¾å¤‡
2. è¿è¡Œåº”ç”¨
3. åˆ‡æ¢åˆ°ä¸²å£æ¨¡å¼
4. åˆ·æ–°å¹¶è¿æ¥ä¸²å£
5. è§‚å¯Ÿè¿æ¥çŠ¶æ€

### 3. é€šä¿¡æµ‹è¯•

1. è¿›å…¥è°ƒè¯•é¡µé¢
2. å‘é€æ¡æ‰‹æŒ‡ä»¤
3. è§‚å¯Ÿä¸²å£æ¥æ”¶æ•°æ®
4. éªŒè¯å“åº”æ­£ç¡®

### 4. çƒ§å½•æµ‹è¯•

1. åŠ è½½HEXæ–‡ä»¶
2. å¼€å§‹çƒ§å½•
3. è§‚å¯Ÿè¿›åº¦
4. éªŒè¯çƒ§å½•æˆåŠŸ

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. âœ… `lib/data/datasources/communication_datasource.dart` - ç»Ÿä¸€é€šä¿¡æ¥å£
2. âœ… `lib/data/datasources/serial_port_datasource.dart` - ä¸²å£æ•°æ®æºå®ç°

### ä¿®æ”¹æ–‡ä»¶
1. âœ… `pubspec.yaml` - æ·»åŠ  flutter_libserialport ä¾èµ–
2. âœ… `lib/presentation/providers/providers.dart` - æ·»åŠ ä¸²å£ç›¸å…³providers
3. âœ… `lib/presentation/screens/scan_screen.dart` - æ·»åŠ ä¸²å£UI
4. âœ… `lib/data/repositories/communication_repository_impl.dart` - æ”¯æŒä¸¤ç§æ•°æ®æº
5. âœ… `lib/data/services/flash_worker.dart` - è§£è€¦æ•°æ®æºä¾èµ–

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜1: æ‰¾ä¸åˆ°ä¸²å£è®¾å¤‡

**åŸå› **:
- USBè®¾å¤‡æœªè¿æ¥
- é©±åŠ¨æœªå®‰è£…
- æƒé™ä¸è¶³ï¼ˆLinuxï¼‰

**è§£å†³**:
```bash
# Linux: æ·»åŠ ç”¨æˆ·åˆ°dialoutç»„
sudo usermod -a -G dialout $USER
# é‡æ–°ç™»å½•ç”Ÿæ•ˆ

# æ£€æŸ¥è®¾å¤‡
ls -l /dev/ttyUSB*
```

### é—®é¢˜2: è¿æ¥å¤±è´¥

**åŸå› **:
- ä¸²å£è¢«å…¶ä»–ç¨‹åºå ç”¨
- æ³¢ç‰¹ç‡ä¸åŒ¹é…
- è®¾å¤‡ä¸æ”¯æŒ

**è§£å†³**:
- å…³é—­å…¶ä»–ä¸²å£å·¥å…·
- æ£€æŸ¥è®¾å¤‡æ³¢ç‰¹ç‡è®¾ç½®
- å°è¯•ä¸åŒçš„ä¸²å£

### é—®é¢˜3: æ•°æ®æ¥æ”¶å¼‚å¸¸

**åŸå› **:
- æ³¢ç‰¹ç‡é”™è¯¯
- æ•°æ®æ ¼å¼ä¸åŒ¹é…
- ç¡¬ä»¶é—®é¢˜

**è§£å†³**:
- ç¡®è®¤æ³¢ç‰¹ç‡ä¸º2000000
- æ£€æŸ¥åè®®é…ç½®
- æµ‹è¯•ç¡¬ä»¶è¿æ¥

### é—®é¢˜4: I/Oé”™è¯¯ (errno = 5)

**é”™è¯¯ä¿¡æ¯**:
```
SerialPortError: è¾“å…¥/è¾“å‡ºé”™è¯¯, errno = 5
```

**åŸå› **:
- USBè®¾å¤‡åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æ–­å¼€
- ä¸²å£é©±åŠ¨ä¸ç¨³å®š
- è®¾å¤‡ä¸æ”¯æŒé«˜æ³¢ç‰¹ç‡ï¼ˆ2000000ï¼‰
- æƒé™ä¸è¶³æˆ–è¢«å…¶ä»–ç¨‹åºå ç”¨
- USBçº¿ç¼†è´¨é‡é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:

1. **æ£€æŸ¥è®¾å¤‡è¿æ¥**:
   ```bash
   # æŸ¥çœ‹ä¸²å£è®¾å¤‡
   ls -l /dev/ttyUSB*

   # æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯
   dmesg | tail -20
   ```

2. **é™ä½æ³¢ç‰¹ç‡æµ‹è¯•**:
   ä¿®æ”¹ `serial_port_datasource.dart` ä¸­çš„é»˜è®¤æ³¢ç‰¹ç‡ï¼š
   ```dart
   // ä» 2000000 é™ä½åˆ° 115200 æµ‹è¯•
   Future<void> connect(
     String portName, {
     int baudRate = 115200,  // é™ä½æ³¢ç‰¹ç‡
   })
   ```

3. **æ£€æŸ¥æƒé™**:
   ```bash
   # æ·»åŠ ç”¨æˆ·åˆ°dialoutç»„
   sudo usermod -a -G dialout $USER

   # é‡æ–°ç™»å½•æˆ–é‡å¯

   # æ£€æŸ¥æƒé™
   groups
   ```

4. **æ£€æŸ¥è®¾å¤‡å ç”¨**:
   ```bash
   # æŸ¥çœ‹å“ªä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨ä¸²å£
   sudo lsof | grep ttyUSB

   # æˆ–ä½¿ç”¨fuser
   sudo fuser /dev/ttyUSB0
   ```

5. **æµ‹è¯•ä¸²å£è®¾å¤‡**:
   ```bash
   # ä½¿ç”¨minicomæµ‹è¯•
   sudo apt install minicom
   sudo minicom -D /dev/ttyUSB0 -b 115200

   # æˆ–ä½¿ç”¨screen
   screen /dev/ttyUSB0 115200
   ```

6. **æ›´æ¢USBçº¿ç¼†**:
   - ä½¿ç”¨è´¨é‡å¥½çš„USBçº¿ç¼†
   - é¿å…ä½¿ç”¨USBå»¶é•¿çº¿
   - ç›´æ¥è¿æ¥åˆ°ç”µè„‘USBå£

7. **æ£€æŸ¥é©±åŠ¨**:
   ```bash
   # æŸ¥çœ‹USBè®¾å¤‡
   lsusb

   # æŸ¥çœ‹å†…æ ¸æ¶ˆæ¯
   dmesg | grep tty
   ```

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**:
å¦‚æœé«˜æ³¢ç‰¹ç‡ä¸ç¨³å®šï¼Œå¯ä»¥é™ä½æ³¢ç‰¹ç‡ï¼š
- 2000000 â†’ 921600
- 921600 â†’ 460800
- 460800 â†’ 115200

ä¿®æ”¹è¿æ¥ä»£ç ï¼š
```dart
await serialPortDatasource.connect(portName, baudRate: 115200);
```

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†USBä¸²å£æ”¯æŒï¼Œç°åœ¨åº”ç”¨å¯ä»¥ï¼š

âœ… **åŒæ¨¡å¼é€šä¿¡**: æ”¯æŒè“ç‰™å’Œä¸²å£ä¸¤ç§æ–¹å¼
âœ… **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰åŠŸèƒ½æ— ç¼åˆ‡æ¢
âœ… **å®Œæ•´åŠŸèƒ½**: çƒ§å½•ã€è°ƒè¯•ã€å‚æ•°è¯»å†™å…¨éƒ¨æ”¯æŒ
âœ… **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„UIå’Œé”™è¯¯æç¤º
âœ… **æ¶æ„ä¼˜é›…**: è§£è€¦è®¾è®¡ï¼Œæ˜“äºæ‰©å±•

**æ ¸å¿ƒä¼˜åŠ¿**:
- ğŸ”Œ å³æ’å³ç”¨çš„USBä¸²å£æ”¯æŒ
- ğŸ”„ è“ç‰™å’Œä¸²å£æ— ç¼åˆ‡æ¢
- ğŸ“¦ å®Œå…¨å¤ç”¨ç°æœ‰åè®®æ ˆ
- ğŸ¨ ç»Ÿä¸€çš„ç”¨æˆ·ä½“éªŒ
- ğŸ› ï¸ æ˜“äºç»´æŠ¤å’Œæ‰©å±•

ç°åœ¨å¯ä»¥åœ¨æ²¡æœ‰è“ç‰™çš„ç¯å¢ƒä¸‹ä½¿ç”¨USBä¸²å£è¿›è¡Œè®¾å¤‡ç¼–ç¨‹ï¼
