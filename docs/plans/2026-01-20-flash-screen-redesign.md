# 烧录页面重新布局设计

## 设计日期
2026-01-20

## 设计目标
优化烧录页面的操作流程，使布局更直观、更符合用户的自然操作顺序。

## 核心改进
1. **简化布局** - 从四段式改为三段式，移除独立的进度区
2. **优化流程** - 自然的从上到下操作顺序：选择 → 设置 → 烧录
3. **进度浮层** - 烧录进度以对话框形式显示，不占用主界面空间
4. **空间优化** - 固件选择区获得更多空间（增加 68%）

## 整体架构

### 主界面布局（三段式）

```
┌─────────────────────────┐
│  固件选择区              │  ← Expanded（占据剩余空间）
│  - 标题                  │
│  - 文件信息卡片          │
│  - [从文件选择] 按钮     │
├─────────────────────────┤
│  初始化设置（紧凑）      │  ← 固定高度 ~50px
│  [⚙️] 设置摘要  [🎛️调整] │
├─────────────────────────┤
│  [开始烧录] 大按钮       │  ← 固定高度 ~80px
└─────────────────────────┘
```

### 空间分配（假设 600px 高度）
- 固件选择区：~470px（78%）⬆️ 从 280px 增加到 470px
- 初始化设置：~50px（8%）
- 操作按钮：~80px（14%）

## 烧录进度浮层设计

### 触发机制
- 点击"开始烧录"按钮后立即弹出
- 使用 `showDialog` 显示对话框
- 设置 `barrierDismissible: false` 防止误触关闭

### 对话框结构

```
┌─────────────────────────────┐
│  烧录进度                    │
│  ─────────────────────────  │
│                             │
│  [========●────────] 45%    │  ← 大号进度条
│  正在烧录第 5/10 块...      │  ← 状态消息
│                             │
│  ⏱️ 已用时: 00:23           │  ← 时间信息
│  📊 速度: 2.5 KB/s          │
│                             │
│  [展开详细日志 ▼]           │  ← 可选的日志区
│                             │
│         [停止烧录]          │  ← 底部操作
└─────────────────────────────┘
```

### 状态处理

#### 1. 烧录中
- 显示实时进度条和百分比
- 显示当前状态消息
- 显示已用时间和速度
- 提供"停止烧录"按钮

#### 2. 烧录成功
- 显示绿色成功图标 ✅
- 显示总用时和统计信息
- 按钮变为"完成"，点击关闭对话框
- 自动返回主界面

#### 3. 烧录失败
- 显示红色错误图标 ❌
- 显示失败原因
- 提供"重试"和"关闭"按钮
- 重试时保持对话框打开，重新开始烧录

### 详细日志区（可展开）
- 默认折叠，节省空间
- 点击"展开详细日志"后显示
- 使用 `ExpansionTile` 或类似组件
- 显示滚动的日志列表
- 每条日志带时间戳

## 主界面详细设计

### 固件选择区
**组件**：
- 标题行（图标 + "选择固件文件"）
- Expanded 区域：
  - 未选择：显示上传图标
  - 已选择：显示文件信息卡片（可滚动）
- 底部按钮："从文件选择"

**改进**：
- 移除进度区后，获得更多垂直空间
- 文件信息卡片可以完整显示
- 滚动体验更流畅

### 初始化设置区
**保持当前设计**：
- 紧凑的一行显示
- 左侧：设置图标 + 标题 + 摘要
- 右侧：调整按钮
- 点击调整按钮弹出设置对话框

### 操作按钮区
**设计要点**：
- 大号按钮（高度 56-64px）
- 全宽设计，视觉突出
- 根据状态显示不同文本：
  - 未选择文件：禁用状态
  - 已选择文件：蓝色"开始烧录"
  - 烧录失败后：橙色"重试"

## 技术实现要点

### 1. 移除进度区
- 从主界面 `Column` 中移除 `_buildFlashProgressSection`
- 删除相关的 flex 分配
- 固件选择区的 flex 不再需要，直接使用 `Expanded`

### 2. 创建进度对话框
```dart
Future<void> _showFlashProgressDialog() async {
  await showDialog(
    context: context,
    barrierDismissible: false,
    builder: (context) => FlashProgressDialog(
      // 传入必要的 providers
    ),
  );
}
```

### 3. 状态管理
- 使用现有的 `flashProgressProvider` 监听进度
- 对话框内部使用 `Consumer` 监听状态变化
- 成功/失败时自动更新 UI

### 4. 日志展开
- 使用 `ExpansionTile` 或自定义展开组件
- 日志列表使用 `ListView.builder`
- 限制最大高度，超出可滚动

## 用户体验流程

### 正常流程
1. 用户打开烧录页面
2. 点击"从文件选择"选择固件
3. （可选）点击设置按钮调整初始化参数
4. 点击"开始烧录"按钮
5. 弹出进度对话框，显示实时进度
6. 烧录完成，显示成功提示
7. 点击"完成"关闭对话框，返回主界面

### 异常流程
1. 烧录过程中出现错误
2. 对话框显示错误信息
3. 用户可以选择"重试"或"关闭"
4. 重试时重新开始烧录流程

## 优势总结

### 1. 空间利用
- 固件选择区空间增加 68%
- 不再有布局溢出问题
- 文件信息完整显示

### 2. 流程清晰
- 自然的从上到下操作顺序
- 主要操作（开始烧录）最突出
- 进度不干扰主界面

### 3. 用户体验
- 减少视觉干扰
- 专注当前任务
- 进度信息集中显示

### 4. 实现简单
- 基于现有代码改造
- 不需要复杂的状态管理
- 易于维护和扩展

## 后续优化建议

1. **进度对话框动画** - 添加淡入淡出动画
2. **烧录历史** - 记录最近的烧录记录
3. **快捷重烧** - 成功后提供"再次烧录"选项
4. **进度通知** - 应用在后台时显示系统通知

## 实现检查清单

- [ ] 移除主界面的进度区
- [ ] 调整固件选择区为 Expanded
- [ ] 优化操作按钮样式和大小
- [ ] 创建进度对话框组件
- [ ] 实现进度实时更新
- [ ] 实现成功/失败状态处理
- [ ] 添加详细日志展开功能
- [ ] 测试各种状态切换
- [ ] 测试错误处理和重试
- [ ] 验证布局在不同屏幕尺寸下的表现
